<style lang="less">
  .container{
    overflow: hidden;
    padding-bottom:116rpx;
  }
  .detail-info{
    position:relative;
    height:575rpx;
    width:100%;
    .detail-img{
      width:525rpx;
      height:525rpx;
      background:#fff;
      padding:20px 0;
      box-sizing:border-box;
      position:absolute;
      left:10px;
      top:10px;
      z-index:9;
      overflow:hidden;
      box-shadow: 2px 2px 2px #eee;
      image{
        width:505rpx;
        height:505rpx;
      }
    }
    .detail-dots{
      position:absolute;
      top:14px;
      left:520rpx;
      z-index:999;
      .detail-dots-gray, .detail-dots-orange{
        width:7px;
        height:7px;
        border-radius:50%;
        background:#eee;
        position:absolute;
        left:0;
        top:0;
        z-index:999;
      }
      .detail-solid{
        width:1px;
        height:15px;
        background:#fc5e44;
        position:absolute;
        left:3px;
        top:4px;
        z-index:9999;
      }
      .detail-dots-orange{
        background:#fff;
        top:16px;
      }
    }
    .detail-txt{
      position:absolute;
      right:10px;
      top:25px;
      width: 225rpx;
      height:525rpx;
      background:#fff;
      box-shadow:2px 2px 2px #eee;
      z-index:998;
      font-size: 32rpx;
      line-height:40rpx;
      text{
       display:block;
       text-align: center;
      }
      .detail-txt-layer{
        background:url('data:image/png;base64,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');
        background-size:cover;
        width:100%;
        height:140rpx;
        color:#fff;
        position:relative;
        .detail-txt-content{
          position:absolute;
          top:50%;
          left:50%;
          transform:translate(-50%, -50%);
          z-index:998;
          text-align:center;
        }
      }
      .detail-txt-price{
        padding:16rpx 30rpx 20rpx; 
        text-align:center;
        color:#333;
        border-bottom:1px #eee solid;
        font-size:28rpx;
        &:last-child{
          border-bottom:none;
        }
        .detail-link{
          border-bottom:1px #fc5e44 solid;
          color:#fc5e44;
          display:inline-block;
        }
        &.express{
          text-align:left;
          .tips{
            color:#999;
            font-size:28rpx;
          }
        }
        .default-button{
          margin-top:5px;
          padding: 6rpx 0;
        }
      }
    }
  }
  .content{
    padding:20rpx 30rpx;
    margin-top:10px;
    margin-bottom:0;
  }
  .detail-title{
    border-bottom:1px #eee solid;
    padding:10rpx 0 20rpx;
    margin-bottom:20rpx;
  }
  .detail-collect{
    display:flex;
    align-items:stretch;
    .detail-collect-icon{
      width:18%;
      text-align:center;
      text{
        display:block;
      }
      image{
        width:80rpx;
        height:69rpx;
      }
      .collect-txt{
        color:#666;
        font-size:28rpx;
      }
      &.collected{
        .iconfont, .collect-txt{
          color:#fc5e43;
        }
      }
    }
    .detail-collect-user{
      width:80%;
      margin-left:2%;
      .detail-collect-detail{
        overflow:hidden;
        .iconfont{
          font-size:28rpx;
          color:#999;
          float:right;
          margin-top:18rpx;
        }
        .section{
          margin-top:10rpx;
        }
      }
      .detail-collect-list{
        margin-top:10rpx;
        min-height: 84rpx;
        view{
          width: 74rpx;
          height: 74rpx;
          background: #eee;
          margin-right:5px;
          display:inline-block;
          overflow:hidden;
          &:last-child{
            margin-left: 0;
          }
          image{
            width:100%;
            height:100%;
          }
        }
      }
    }
    .un-collect{
      padding:10rpx 20rpx;
      color:#fff;
      background:#ffa336;
      font-size:24rpx;
      &.collect{
        background:#fc5e43;
      }
    }
    .icon-leftsj{
      color:#ffa336;
      vertical-align:middle;
      margin-right:-10rpx;
      font-size:30rpx;
      &.collect{
        color:#fc5e43;
      }
    }
  }
  .detail-container{
    margin-bottom:10px;
    .section{
      margin-bottom:5px;
    }
    .detail-goods{
      display:flex;
      padding:4rpx 0 4rpx 28rpx;
      font-size:24rpx;
      color:#333;
      line-height:36rpx;
      .detail-goods-title{
        width: 20%;
      }
      .detail-goods-content{
        width: 80%;
      }
    }
  }
  .popup{
    width:100%;
    height:100%;
    background:rgba(0,0,0,0.6);
    position:fixed;
    top:0;
    left:0;
    z-index:999999;
  }
  .popup__content {
    position:fixed;
    bottom:-100%;
    left:0;
    transition: .5s all ease-out;
    width: 100%;
    min-height: 500rpx;
    background: #ffffff;
    z-index:9999999;
  }
  .popup__content.active{
    bottom:0;
  }
  .popup_close{
    padding:20rpx 40rpx;
    text-align:right;
  }
  .popup_layer{
    border-top:1px #eee solid;
    padding:20rpx;
    display:flex;
    .popup_image{
      border:1px #eee solid;
      width:200rpx;
      height:200rpx;
      overflow:hidden;
      image{
        width:100%;
        height:100%;
      }
    }
    .popup_goods{
      padding-left: 44rpx;
      padding-top:20rpx;
      width:550rpx;
      box-sizing: border-box;
      .link{
        display:block;
        &.inline{
          float:left;
          margin-top:52rpx;
        }
      }
      .calculate{
        margin-top:20rpx;
        margin-right:20rpx;
        float:left;
      }
      .popup_goods_box{
        display:flex;
        .popup_goods_left{
          width:20%;
          white-space:nowrap;
        }
        .popup_goods_right{
          width: 80%;
        }
      }
    }
    .goods-name{
      width:70%;
      font-size:28rpx;
    }
    .goods-num{
      width:30%;
      font-size:28rpx;
    }
    .none{
      color:#999;
    }
    radio{
      float:right;
    }
  }
  .disable{
    background: #999;
  }
</style>
<template>
  <view class="container" style="height: {{overflow? winHeight : 'auto'}}">
    <menuList></menuList>
    <view class="detail-info">
      <view class="detail-img">
        <image src="{{detail.path}}" mode="aspectFit"></image>
      </view>
      <view class="detail-dots">
        <view class="detail-dots-gray"></view>
        <view class="detail-solid"></view>
        <view class="detail-dots-orange"></view>
      </view>
      <view class="detail-txt">
        <view class="detail-txt-layer">
          <view class="detail-txt-content">
            <text>会员价</text>
            <text>￥{{detail.price}}</text>
          </view>
        </view>
        <view class="detail-txt-price">
          <text>原价</text>
          <text class="{{userLevel === 0 ? '' : 'through'}}">￥{{detail.oldprice}}</text>
          <navigator url="./applyVip" class="detail-link">成为会员?</navigator>
        </view>
        <view class="detail-txt-price express">
          <text>快递￥{{detail.express}}</text>
          <text class="tips">成为会员</text><text class="tips">即享包邮</text>
          <button class="default-button" hover-class="default-button-active" @tap="goRules">配送规则</button>
        </view>
      </view>
    </view>
    <view class="content">
      <view class="detail-title">
        <view class="title">{{detail.title}}</view>
        <view class="goods-promot">
          <view class="goods-promot-image">
            <image src="../image/icon-xian.png"></image>
          </view>
          <view class="goods-info">
            {{detail.descript}}
            <view class="goods-end">
              <image src="../image/probq_bg.png" mode="right"></image>
            </view>
          </view>
        </view>
      </view>
      <view class="detail-collect">
        <view class="detail-collect-icon {{collect? 'collected' : ''}}" @tap="collectTap">
          <image src="{{collect ? '../image/icon-cart.png' : '../image/icon-cart-blank.png'}}"></image>
          <text class="collect-txt">{{collectTxt}}</text>
        </view>
        <view class="detail-collect-user">
          <view class="detail-collect-detail">
            <text class="section">已有{{collectednum}}人收藏了本商品</text>
          </view>
          <view class="detail-collect-list"  wx:if="{{collect}}">
            <text class="iconfont icon-leftsj collect"></text><text class="un-collect collect">收藏成功</text>
          </view>
          <view class="detail-collect-list" wx:else>
            <text class="iconfont icon-leftsj"></text><text class="un-collect">请点击收藏</text>
          </view>
        </view>
      </view>
    </view>
    <view class="content">
      <view class="detail-title">
         <text class="title">商品详情</text>
      </view>
      <view class="detail-container">
         <view class="section">关于商品</view>
         <repeat for="{{goodsDetail}}" item="item" index="index">
           <view class="detail-goods">
              <view class="detail-goods-title">{{item.title}}</view>
              <view class="detail-goods-content">{{item.detail}}</view>
           </view>
         </repeat>
      </view>
      <view class="detail-container">
         <view class="section">关于商品</view>
         <repeat for="{{transportDetail}}" item="item" index="index">
           <view class="detail-goods">
              <view class="detail-goods-title">{{item.title}}</view>
                <view wx:if="{{!item.isLink}}" class="detail-goods-content">{{item.detail}}</view>
                <navigate wx:else to="" class="detail-goods-content link">{{item.detail}}</navigate>
           </view>
         </repeat>
      </view>
      <view class="detail-container">
        <view class="section">关于</view>
      </view>
    </view>
    <bottom @buy.user="cart" @cart.user="cart" :cartVal.sync="addCartCount"></bottom>
    <view class="popup" wx:if="{{overflow}}"></view>
    <view class="popup__content {{overflow && cartModal? 'active' : ''}}">
      <view class="popup_close"><text class="title" @tap.stop="closeCart">关闭</text></view>
      <view class="popup_layer">
        <view class="popup_image">
          <image src="{{detail.path}}" mode="aspectFit"></image>
        </view>
        <view class="popup_goods">
          <view class="popup_goods_box">
            <view class="popup_goods_left">
              <text class="title">已选：</text>
            </view>
            <view class="popup_goods_right">
              <text class="title">{{cartResult.name}} × {{cartNum}}</text>
            </view>
          </view>
          <text class="title link">价格：￥{{totalCart}}</text>
          <counterCart @plusEdit.user="plusCart" @minusEdit.user="minusCart" @keyEdit.user="keyCart" class="calculate" :num.sync="cartNum" @blurEdit.user="blurCart" :isDisabled.sync="noSales"></counterCart>
          <text wx:if="{{maxtip}}" class="title link inline">数量已到上限</text>
        </view>
      </view>
      <radio-group @change="addCartGoods">
        <repeat for="{{detail.goodList}}" item="item" index="index">
          <view class="popup_layer">
            <view class="goods-name {{item.num === 0 ? 'none' : ''}}">{{item.name}}</view>
            <view class="goods-num {{item.num === 0 ? 'none' : ''}}">库存{{item.num === 0 ? '不足' : item.num}}<radio value="{{index}}" color="{{item.num === 0? '#ccc' : '#fc5e43'}}" checked="{{item.checked}}" disabled="{{item.num === 0? true : false}}"></radio></view>
          </view>
        </repeat>
      </radio-group>
      <button class="default-button size-full {{cartResult.num === 0 ? 'disable' : ''}}" @tap.stop="goCart">{{isAddCart ? '加入购物车' : '立即购买'}}</button>
    </view>
  </view>
</template>

<script>
  import wepy from 'wepy'
  import Bottom from '../components/bottombar'
  import Count from '../components/counter'
  import Menu from '../components/menu'

  export default class Detail extends wepy.page {
    config = {
      navigationBarTitleText: '商品详情'
    }
    components = {
      bottom: Bottom,
      counterBuy: Count,
      counterCart: Count,
      menuList: Menu
    }
    computed = {
      totalCart () {
        if (Object.keys(this.cartResult).length > 0) {
          var price = this.cartResult.price.replace(/,/g, '') * this.cartNum
          return price.toFixed(2)
        }
      },
      maxtip () {
        var maxtip = false
        if (this.cartNum >= this.cartResult.num) {
          maxtip = true
        } else {
          maxtip = false
        }
        return maxtip
      },
      noSales () {
        if (this.cartResult.num > 0) {
          return false
        } else {
          return true
        }
      }
    }
    data = {
      detail: {
        path: '',
        price: '',
        oldprice: '',
        express: '38.0',
        title: '',
        goodList: []
      },
      token: '',
      pageId: '',
      collect: false,
      overflow: false,
      winHeight: 0,
      collectTxt: '未收藏',
      collectednum: ' ',
      goodsDetail: [{
        title: '商品名称',
        detail: '美国自然牛USDA PRIMA极佳级肉眼牛排'
      }, {
        title: '商品名称',
        detail: '美国自然牛USDA PRIMA极佳级肉眼牛排'
      }, {
        title: '商品名称',
        detail: '美国自然牛USDA PRIMA极佳级肉眼牛排'
      }, {
        title: '商品名称',
        detail: '美国自然牛USDA PRIMA极佳级肉眼牛排'
      }],
      transportDetail: [{
        title: '配送范围',
        detail: '购满2公斤全国包邮'
      }, {
        title: '配送快递',
        detail: '顺丰冷运'
      }, {
        title: '配送方案',
        detail: '配送规则',
        isLink: true
      }],
      isAddCart: true,
      cartNum: 1,
      addCartCount: 0,
      cartResult: [],
      totalCart: 0,
      cartModal: false,
      collectImage: '../image/icon-cart-blank.png',
      markId: '',
      userLevel: 0
    }
    methods = {
      collectTap () {
        if (!this.collect) {
          this.setMark(() => {
            this.collectTxt = '已收藏'
            this.collect = true
          })
        } else {
          this.CancelMark(() => {
            this.collectTxt = '未收藏'
            this.collect = false
          })
        }
      },
      cart (action) {
        if (action === 'addCart') {
          this.isAddCart = true
        } else if (action === 'addBuy') {
          this.isAddCart = false
        }
        this.overflow = true
        this.cartModal = true
        this.initData(this.pageId, this.initCartResult())
      },
      closeCart () {
        this.overflow = false
        this.cartModal = false
        this.cartNum = this.cartResult.num <= 0 ? 0 : 1
      },
      plusCart () {
        if (this.cartResult.num > 0) {
          this.cartNum ++
          if (this.cartNum > this.cartResult.num) {
            this.cartNum = this.cartResult.num
          }
        }
      },
      minusCart () {
        if (this.cartResult.num > 0) {
          this.cartNum --
          if (this.cartNum <= 0) {
            this.cartNum = 1
          }
        }
        // 发送购物车减少数量
      },
      keyCart (val) {
        this.cartNum = val
        return this.cartNum
      },
      blurCart (val) {
        if (val <= 0) {
          this.cartNum = 1
        } else if (this.cartResult.num > 0 && this.cartNum > this.cartResult.num) {
          this.cartNum = this.cartResult.num
        } else if (this.cartResult.num <= 0) {
          this.cartNum = 0
        } else {
          this.cartNum = val
        }
        return this.cartNum
      },
      addCartGoods (e) {
        // 发送选中结果
        this.cartNum = this.cartResult.num <= 0 ? 0 : 1
        this.cartResult = this.detail.goodList[e.detail.value]
      },
      goCart () {
        if (this.cartResult.num > 0) {
          if (this.isAddCart) {
            if (this.cartNum <= this.cartResult.num) {
              this.addCartCount += parseInt(this.cartNum)
              // 发送添加购物车请求
              this.addCartData()
            }
          } else {
            wepy.navigateTo({
              url: './paybuy?id=' + this.cartResult.id + '&type=' + this.cartResult.type + '&count=' + this.cartNum
            })
          }
          this.methods.closeCart.apply(this)
        }
      },
      goRules () {
        wepy.navigateTo({
          url: './rules'
        })
      }
    }
    initCartData () {
      // 往后台发请求清空购物车选项
    }
    initCartResult () {
      this.cartResult = []
      let result = this.detail.goodList.filter((item) => {
        return item.checked
      })
      this.cartResult = result.length > 0 ? result[0] : this.detail.goodList[0]
      this.cartNum = result.length > 0 ? 1 : 0
    }
    initData (id, cb) {
      this.$parent.showLoading()
      var _this = this
      var data = {
        token: this.token,
        spuId: id
      }
      this.$parent.HttpRequest.DetailHttp(data).then((res) => {
        console.log(res)
        this.detail.goodList = []
        if (res.data.error === 0) {
          _this.$parent.showSuccess()
          var data = res.data.data
          if (!data.collectionId) {
            _this.collect = false
          } else {
            _this.collect = true
          }
          // 测试用户身份变化
          _this.$parent.resetUserLevel(data.memberHash, this.token)
          _this.detail.path = data.cover
          _this.detail.title = data.title
          _this.detail.price = data.memberPrice
          _this.detail.oldprice = data.price
          _this.detail.descript = data.desc
          _this.detail.type = data.sourceType
          _this.detail.id = data.sourceId
          _this.detail.collectId = data.collectionId
          _this.getMarkUser(data.sourceId, data.sourceType)
          if (data.collectionId) {
            _this.collect = true
            _this.collectTxt = '已收藏'
          } else {
            _this.collect = false
            _this.collectTxt = '未收藏'
          }
          data.skus.forEach((item) => {
            var good = {}
            good.name = item.productName + item.title
            if (_this.userLevel === 0) {
              good.price = item.price
            } else if (_this.userLevel === 1) {
              good.price = item.memberPrice
            }
            good.num = item.keepCout
            if (item.keepCout > 0) {
              good.checked = true
            } else {
              good.checked = false
            }
            good.type = item.sourceType
            good.id = item.sourceId
            _this.detail.goodList.push(good)
            _this.$apply()
            cb && cb()
          })
        } else {
          _this.$parent.showFail()
        }
      }).catch(() => {
        _this.$parent.showFail()
      })
    }
    addCartData () {
      var data = {
        token: this.token,
        sourceType: this.cartResult.type,
        sourceId: this.cartResult.id,
        count: this.cartNum
      }
      this.$parent.HttpRequest.AddCartHttp(data).then((res) => {
        console.log(res)
      })
    }
    getMarkUser (id, type) {
      this.collectednum = ' '
      var _this = this
      var data = {
        token: this.token,
        markType: 1,
        sourceType: type,
        sourceId: id
      }
      this.$parent.HttpRequest.GetMarkUser(data).then((res) => {
        console.log(res)
        if (res.data.error === 0) {
          var data = res.data.data
          _this.collectednum = data.length
        }
        _this.$apply()
      })
    }
    setMark (cb) {
      var _this = this
      var data = {
        token: this.token,
        markType: 1,
        sourceType: this.detail.type,
        sourceId: this.detail.id
      }
      console.log(data)
      this.$parent.HttpRequest.SetMarkHttp(data).then((res) => {
        if (res.data.error === 0) {
          _this.markId = res.data.data
          _this.getMarkUser(_this.detail.id, this.detail.type)
          cb && cb()
        }
        _this.$apply()
      })
    }
    CancelMark (cb) {
      var _this = this
      var data = {
        markId: this.markId || this.detail.collectId,
        token: this.token
      }
      this.$parent.HttpRequest.CancelMarkHttp(data).then((res) => {
        _this.getMarkUser(_this.detail.id, this.detail.type)
        cb && cb()
        _this.$apply()
      })
    }
    onLoad (id) {
      this.userLevel = this.$parent.globalData.userLevel
      this.pageId = id.id
      this.token = this.$parent.getToken()
      this.initData(this.pageId)
      this.$parent.pageRoot = true
      var _this = this
      wepy.getSystemInfo({
        success: function (res) {
          _this.winHeight = res.windowHeight + 'px'
        }
      })
      this.$apply()
    }
  }
</script>
